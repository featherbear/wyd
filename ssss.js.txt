// https://testdriven.io/blog/developing-a-single-page-app-with-flask-and-vuejs/

import App from "./App.vue";

import Vue from 'vue'
import Buefy from 'buefy'
import 'buefy/dist/buefy.css'

Vue.use(Buefy)

new Vue({
  el: "#app",
  render: h => h(App)
});

// TODO: Do it properly: https://developers.google.com/calendar/v3/reference/
function CORS(url) {
  return "https://cors-anywhere.herokuapp.com/" + `${url}`;
}

const ical = require("ical.js");
const luxon = require('luxon');

// https://www.raymondcamden.com/2017/08/24/serverless-ical-parsing
function flattenEvent(e) {
  let event = {};
  for (let i = 0; i < e[1].length; i++) {
    let prop = e[1][i];
    event[prop[0]] = prop[3];
  }
  
  // Set dates to Date objects
  event.dtstart = luxon.DateTime.fromISO(event.dtstart)
  event.dtend = luxon.DateTime.fromISO(event.dtend)
  event.interval = luxon.Interval.fromDateTimes(event.dtstart, event.dtend)
  event.dtstamp = luxon.DateTime.fromISO(event.dtstamp)
  event.created = luxon.DateTime.fromISO(event.created)
  event["last-modified"] = luxon.DateTime.fromISO(event["last-modified"])

  return event;

}

// https://fullcalendar.io/docs/vue

fetch(
  CORS(
    "https://calendar.google.com/calendar/ical/zzmetrox%40gmail.com/private-6666a937211db8f9e886851a9e31303f/basic.ics"
  )
)
  .then(e => e.text())
  .then(data => {
    try {
      console.info("Got data");
      let parsed = ical.parse(data);
      console.info("Parse 1");
      let events = parsed[2];

      let result = [];
      events.forEach(e => result.push(flattenEvent(e)));

      function getDay(dayCount) {
        return luxon.DateTime.local().startOf('day').plus({days: dayCount})
      }
      
      let offset = 4;
      let dateToday = getDay(offset + 0);
      let dateTomorrow = getDay(offset + 1)
      
      let interval = luxon.Interval.fromDateTimes(dateToday, dateTomorrow);
      console.info("Interval");
      
      for (let event of result) {
        // if (event.summary == "Church") console.error(event);
        if (interval.overlaps(event.interval)) {
          console.log(event.summary)
        }
      }
      
      console.info("Done");
    
    } catch (e) {
      console.log(e);
    }

  });

